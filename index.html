<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no"/>
  <title>Hoja de Gastos</title>
  
  <meta name="theme-color" content="#0f172a">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Gastos App">
  
  <!-- Iconos -->
  <link rel="icon" type="image/png" sizes="192x192" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxyZWN0IHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgZmlsbD0iIzBmMTcyYSIgcng9IjQiLz48cGF0aCBkPSJtNyA5IDMgM0wyMCA5IiBzdHJva2U9IiNmOWZhZmIiIHN0cm9rZS13aWR0aD0iMiIgZmlsbD0ibm9uZSIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIi8+PHBhdGggZD0iTTIxIDEydjZhMiAyIDAgMCAxLTIgMkg1YTIgMiAwIDAgMS0yLTJWNmEyIDIgMCAwIDEgMi0yaDE0YTIgMiAwIDAgMSAyIDJ2NiIgc3Ryb2tlPSIjZjlmYWZiIiBzdHJva2Utd2lkdGg9IjIiIGZpbGw9Im5vbmUiLz48L3N2Zz4=">
  <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxyZWN0IHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgZmlsbD0iIzBmMTcyYSIgcng9IjQiLz48cGF0aCBkPSJtNyA5IDMgM0wyMCA5IiBzdHJva2U9IiNmOWZhZmIiIHN0cm9rZS13aWR0aD0iMiIgZmlsbD0ibm9uZSIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIi8+PHBhdGggZD0iTTIxIDEydjZhMiAyIDAgMCAxLTIgMkg1YTIgMiAwIDAgMS0yLTJWNmEyIDIgMCAwIDEgMi0yaDE0YTIgMiAwIDAgMSAyIDJ2NiIgc3Ryb2tlPSIjZjlmYWZiIiBzdHJva2Utd2lkdGg9IjIiIGZpbGw9Im5vbmUiLz48L3N2Zz4=">
  
  <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIkdhc3RvcyBBcHAiLAogICJzaG9ydF9uYW1lIjogIkdhc3RvcyIsCiAgImRlc2NyaXB0aW9uIjogIkFwbGljYWNpw7NuIHBhcmEgZ2VzdGlvbmFyIGdhc3RvcyBtZW5zdWFsZXMiLAogICJzdGFydF91cmwiOiAiLiIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgImJhY2tncm91bmRfY29sb3IiOiAiIzBmMTcyYSIsCiAgInRoZW1lX2NvbG9yIjogIiMwZjE3MmEiLAogICJpY29ucyI6IFsKICAgIHsKICAgICAgInNyYyI6ICJkYXRhOmltYWdlL3N2Zyt4bWw7YmFzZTY0LFBITjJaeUIzYVdSMGFEMGlNVGt5SWlCb1pXbG5hSFE5SWpFNU1pSWdkbWxsZDBKdmVEMGlNQ0F3SURJMFNUSTEELSI7CiAgICAgICJzaXplcyI6ICIxOTJ4MTkyIiwKICAgICAgInR5cGUiOiAiaW1hZ2Uvc3ZnK3htbCIsCiAgICAgICJwdXJwb3NlIjogImFueSBtYXNrYWJsZSIKICAgIH0sCiAgICB7CiAgICAgICJzcmMiOiAiZGF0YTppbWFnZS9zdmcreG1sO2Jhc2U2NCxQSE4yWnlCM2FXUjBhRDBpTlRFeUlpQm9aV2xuYUhROUlqVXhNaUlnZG1sbGQwSnZlRDBpTUNBd0lESTBTVEkwLS0tLS0tLS0tLS0tLS0tLS0tLS0iLAogICAgICAic2l6ZXMiOiAiNTEyeDUxMiIsCiAgICAgICJ0eXBlOiAiaW1hZ2Uvc3ZnK3htbCIsCiAgICAgICJwdXJwb3NlIjogImFueSBtYXNrYWJsZSIKICAgIH0KICBdCn0">
  
  <!-- LIBRER√çA PARA EL GR√ÅFICO -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* --- CONFIGURACI√ìN DE COLUMNAS DE LA TABLA --- */
    /* Nueva Columna Categoria */
    #gastos-table th:nth-child(1), 
    #gastos-table td:nth-child(1) { width: 45px; min-width: 45px; padding: 0;} /* Cat */
    
    #gastos-table th:nth-child(2), 
    #gastos-table td:nth-child(2) { width: auto; min-width: 100px; } /* Nombre */
    
    #gastos-table th:nth-child(3), 
    #gastos-table td:nth-child(3) { width: 90px; min-width: 90px; } /* Importe */
    
    #gastos-table th:nth-child(4), 
    #gastos-table td:nth-child(4) { width: 50px; min-width: 50px; } /* Check */
    
    #gastos-table th:nth-child(5), 
    #gastos-table td:nth-child(5) { width: 40px; min-width: 40px; } /* Delete */
    
    /* Centrar contenido de la columna de estado para el checkbox */
    #gastos-table td:nth-child(4) {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100%;
      padding: 5px 0;
    }

    /* Select de Categor√≠a (Emoji) */
    .cat-select {
        appearance: none; -webkit-appearance: none;
        background: transparent; border: none;
        font-size: 1.2rem; text-align: center;
        width: 100%; cursor: pointer; padding: 0;
        margin: 0;
    }
    .cat-select option { background: #1e293b; color: #fff; }

    /* ESTILO PARA FILA DE GRUPO */
    .group-header td {
        background: rgba(255, 255, 255, 0.1);
        color: var(--primary);
        font-weight: bold;
        text-align: left;
        padding: 8px;
        border-top: 1px solid var(--glass-border);
        border-bottom: 1px solid var(--glass-border);
        cursor: pointer;
        user-select: none;
        transition: background 0.2s;
    }
    .group-header:active td {
        background: rgba(255, 255, 255, 0.2);
    }
    .arrow-icon {
        display: inline-block;
        transition: transform 0.2s ease;
        margin-right: 5px;
        font-size: 0.8em;
    }
    .group-collapsed .arrow-icon {
        transform: rotate(-90deg);
    }

    /* --- HEADER (MES Y A√ëO) --- */
    .header-controls {
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .selector-fecha {
        font-size: 1.5rem;
        font-weight: bold;
        padding: 8px 15px;
        color: var(--text);
        text-align: center;
        background: var(--glass-bg);
        border: 1px solid var(--glass-border);
        border-radius: 12px;
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        appearance: none;
        -webkit-appearance: none;
        cursor: pointer;
    }
    
    @media(max-width: 450px) {
        .selector-fecha {
            font-size: 1.2rem;
            padding: 6px 10px;
        }
    }

    .header-row {
        display:flex;
        align-items: center; 
        justify-content: center;
        gap:10px;
        margin-bottom:20px;
        flex-wrap:wrap;
        position:relative;
        width: 100%;
    }
    
    :root {
      --glass-bg: rgba(255,255,255,0.08);
      --glass-border: rgba(255,255,255,0.2);
      --primary: #3b82f6;
      --success: #22c55e;
      --danger: #ef4444;
      --text: #f9fafb;
      --ingresos-bg: rgba(59, 130, 246, 0.1);
      --resumen-bg: rgba(34, 197, 94, 0.1);
      --division-bg: rgba(239, 68, 68, 0.1);
      --ingresos-color: #f9fafb;
      --restante-color: #22c55e;
      --gasto-semanal-color: #f59e0b;
      --bg-start: #0f172a;
      --bg-end: #000000;
      --base-font-size: 16px;
      --valor-label-fs: 0.9rem;
      --ingreso-importe-fs: 1rem;
      --restante-importe-fs: 1.5rem;
      --gasto-semanal-importe-fs: 1.5rem;
    }
    * {box-sizing:border-box;transition:all .2s ease;}
    
    html { height: 100%; margin: 0; padding: 0; background: #000000; }
    
    body {
        min-height: 100vh; min-height: 100dvh;
        overflow: hidden; margin: 0; padding: 0;
        position: fixed; width: 100%; top: 0; left: 0; right: 0; bottom: 0;
        background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #000000 100%);
        color: var(--text);
        font-family: Segoe UI, sans-serif;
        font-weight: bold;
        font-size: var(--base-font-size);
        overscroll-behavior: none;
        -webkit-overflow-scrolling: touch;
    }

    .main-wrapper {
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        overflow-y: auto; overflow-x: hidden;
        -webkit-overflow-scrolling: touch;
        overscroll-behavior: none;
        background: transparent;
        padding: env(safe-area-inset-top, 20px) env(safe-area-inset-right, 20px) env(safe-area-inset-bottom, 20px) env(safe-area-inset-left, 20px);
    }

    .container {
        display:grid; grid-template-columns:2fr 1fr; gap:20px;
        max-width:1200px; margin:0 auto; padding-bottom: 20px;
    }
    .full-width-card { grid-column: 1 / -1; }

    h1 {text-align:center;margin-bottom:10px;font-size:2rem;}
    select,input,button{
      padding:6px 10px;border-radius:8px;
      border:1px solid var(--glass-border);
      background:var(--glass-bg);color:var(--text);
      backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);
      font-weight:bold; font-size: inherit;
      -webkit-tap-highlight-color: transparent; touch-action: manipulation;
    }
    select option {color:#000;}
    button{cursor:pointer;}
    
    .card {
      background:var(--glass-bg);border:1px solid var(--glass-border);
      border-radius:16px;
      -webkit-backdrop-filter:blur(12px);padding:20px;
      box-shadow:0 8px 24px rgba(0,0,0,0.3);
    }
    table {width:100%;border-collapse:collapse;margin-top:10px;font-weight:bold;}
    th,td { padding:2px 2px; border-bottom:1px solid var(--glass-border); text-align:center; border-right:1px solid var(--glass-border); }
    th:last-child, td:last-child {border-right:none;}
    th {background:rgba(255,255,255,0.05);}
    
    .gasto-actions { display: flex; gap: 10px; margin-bottom: 10px; }
    #agregar-gasto { background:linear-gradient(90deg, #0022e0, #00106b);border:none;color:#fff; padding:8px 14px;border-radius:8px; flex-grow: 1; }
    #copiar-gastos { background:linear-gradient(90deg, #5e0000, #c20000); border: none; color: #fff; padding: 8px 14px; border-radius: 8px; }
    
    .btn {padding:6px 10px;border:none;border-radius:6px;color:#fff;font-weight:bold;}
    .pagado {background:var(--success);}
    .no-pagado {background:var(--danger);}
    .delete-btn {background:transparent;color:#e22828;border:none;font-size:1rem;cursor:pointer;}
    
    .ingresos-resumen {display: flex;flex-direction: column;gap: 15px;}
    .seccion {padding: 15px;border-radius: 12px;border: 1px solid var(--glass-border);}
    .seccion-ingresos {background: var(--ingresos-bg);}
    .seccion-resumen {background: var(--resumen-bg);}
    .seccion-division {background: var(--division-bg);}
    .inputs-ingresos {display: flex;flex-direction: column;gap: 15px;}
    .input-group {display: flex;flex-direction: column;}
    .input-group label {margin-bottom: 5px;font-size: var(--valor-label-fs);}
    .input-group input { width: 100%;padding: 8px 12px; font-size: var(--ingreso-importe-fs); border-radius: 8px;border: 1px solid var(--glass-border); background: rgba(0, 0, 0, 0.2);color: var(--ingresos-color); -moz-appearance: textfield; }
    .input-group input::-webkit-outer-spin-button, .input-group input::-webkit-inner-spin-button {-webkit-appearance: none;margin: 0;}
    .resumen {display: flex;flex-direction: column;gap: 10px;}
    .division {display: flex;align-items: center;justify-content: space-between;gap: 10px;margin-bottom: 10px;}
    .valor-display { display: flex;flex-direction: column;align-items: center; text-align: center;padding: 8px;background: rgba(0, 0, 0, 0.2);border-radius: 8px; }
    .valor-label {font-size: var(--valor-label-fs);margin-bottom: 5px;opacity: 0.9;}
    #total-restante .valor-importe {color: var(--restante-color); font-size: var(--restante-importe-fs); font-weight: bold;}
    #total-por-parte .valor-importe {color: var(--gasto-semanal-color); font-size: var(--gasto-semanal-importe-fs); font-weight: bold;}
    .separador {height: 1px;background: var(--glass-border);margin: 10px 0;}
    
    .config-btn { background: transparent;border: 1px solid var(--glass-border);border-radius: 50%; width: 40px;height: 40px;display: flex;align-items: center;justify-content: center; font-size: 1.2rem;cursor: pointer; }
    .config-menu { position: absolute;top: 100%;right: 0;background: var(--glass-bg); border: 1px solid var(--glass-border);border-radius: 12px;padding: 15px; backdrop-filter: blur(20px);-webkit-backdrop-filter:blur(20px); box-shadow: 0 8px 24px rgba(0,0,0,0.5);z-index: 100;display: none; min-width: 320px;margin-top: 10px; }
    .config-menu.active {display: block;}
    .config-menu h4 {margin: 0 0 15px 0; text-align: center;}
    .config-menu h5 { margin: 15px 0 10px 0; border-bottom: 1px solid var(--glass-border); padding-bottom: 5px; }
    .color-picker {display: flex;align-items: center;margin-bottom: 12px;gap: 10px;}
    .range-slider {display: flex;align-items: center;gap: 10px;margin-bottom: 12px;}
    .range-slider input[type="range"] {flex-grow: 1;}
    
    tr.pagado-row { background-color: rgba(34,197,94,0.3); }

    .chart-container { position: relative; height: 300px; width: 100%; display: flex; justify-content: center; align-items: center; }
    
    #gastos-comparacion { margin-top: 10px; font-weight: bold; text-shadow: 0 2px 4px rgba(0,0,0,0.3); }

    /* --- ESTILOS DE LOS MODALES --- */
    .modal-overlay {
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        z-index: 2000;
        display: flex;
        justify-content: center;
        align-items: center;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease, visibility 0.3s ease;
    }
    .modal-overlay.active {
        opacity: 1;
        visibility: visible;
    }

    .modal-content {
        background: rgba(30, 41, 59, 0.8);
        border: 1px solid rgba(255, 255, 255, 0.2);
        box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        border-radius: 20px;
        padding: 25px;
        width: 90%;
        max-width: 400px;
        text-align: center;
        transform: scale(0.9);
        transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    .modal-overlay.active .modal-content {
        transform: scale(1);
    }

    .modal-title {
        font-size: 1.5rem;
        margin-bottom: 10px;
        color: var(--primary);
    }
    .modal-message {
        margin-bottom: 25px;
        font-weight: normal;
        line-height: 1.5;
        font-size: 1.1rem;
    }
    .modal-buttons {
        display: flex;
        gap: 15px;
        justify-content: center;
    }
    .btn-modal {
        flex: 1;
        padding: 12px;
        border-radius: 10px;
        font-size: 1rem;
        border: none;
        color: white;
    }
    .btn-modal-cancel { background: #64748b; }
    .btn-modal-confirm { background: var(--primary); }
    .btn-modal-delete { background: var(--danger); }
    
    /* PWA */
    .install-prompt { position: fixed; bottom: 20px; left: 20px; right: 20px; background: var(--primary); color: white; padding: 15px; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.3); display: none; align-items: center; gap: 10px; z-index: 1000; }
    .install-prompt button { background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 8px 12px; border-radius: 6px; font-size: 0.9rem; }
    .install-prompt .close { background: transparent; border: none; color: white; font-size: 1.5rem; padding: 0; width: 30px; height: 30px; margin-left: auto; }
    
    @supports (-webkit-touch-callout: none) { html { background: #000000; } body { background: linear-gradient(135deg, #0f172a 0%, #000000 100%); } }
    @media(max-width:900px){ .container{grid-template-columns:1fr;} .config-menu {right: auto;left: 0;} }

    /* --- ESTILOS NUEVO CHECKBOX (SVG) --- */
    .checkbox {
      display: block;
      position: relative;
      cursor: pointer;
      user-select: none;
      margin: 0 auto;
    }

    .checkbox input {
      cursor: none;
      position: absolute;
      pointer-events: none;
      opacity: 0;
      height: 0;
      width: 0;
    }

    .checkmark {
      --sizer: 30px; /* Ajustado para la tabla */
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      stroke-width: 6;
      stroke-linecap: round;
      stroke-linejoin: round;
      z-index: 1;
      border-radius: 999px;
    }
    .checkmark,
    .checkmark path {
      transition: all 0.5s linear 0s, stroke 0.15s, fill 0.15s;
    }

    /* Estado: PAGADO (Verde) */
    .checkbox input:checked ~ .checkmark {
      fill: hsl(108, 62%, 55%);
      stroke: hsl(0, 0%, 100%);
    }
    .checkbox input:checked ~ .checkmark path {
      stroke-dashoffset: 162.6;
      stroke-dasharray: 0 162.6 28 134.6;
    }

    /* Estado: NO PAGADO (Rojo/Blanco) */
    .checkbox input:where(:not(:checked)) ~ .checkmark {
      fill: hsl(0, 0%, 100%);
      stroke: hsl(0, 62%, 55%);
    }
    .checkbox input:where(:not(:checked)) ~ .checkmark path {
      stroke-dashoffset: 162.6;
      stroke-dasharray: 0 200 158 134.6;
    }

    .sizer {
      width: var(--sizer);
      min-width: var(--sizer);
      max-width: var(--sizer);
      height: var(--sizer);
      min-height: var(--sizer);
      max-height: var(--sizer);
    }
  </style>
</head>
<body>
  
  <!-- --- MODALES (HTML) --- -->
  <div id="info-modal" class="modal-overlay">
    <div class="modal-content">
      <h3 class="modal-title" id="info-modal-title">Informaci√≥n</h3>
      <p class="modal-message" id="info-modal-message">Mensaje aqu√≠</p>
      <div class="modal-buttons">
        <button class="btn-modal btn-modal-confirm" id="info-modal-ok">Aceptar</button>
      </div>
    </div>
  </div>

  <div id="confirm-modal" class="modal-overlay">
    <div class="modal-content">
      <h3 class="modal-title" id="confirm-modal-title">Confirmar</h3>
      <p class="modal-message" id="confirm-modal-message">¬øEst√°s seguro?</p>
      <div class="modal-buttons">
        <button class="btn-modal btn-modal-cancel" id="confirm-modal-cancel">Cancelar</button>
        <button class="btn-modal btn-modal-confirm" id="confirm-modal-yes">Confirmar</button>
      </div>
    </div>
  </div>

  <div class="install-prompt" id="install-prompt">
    <span>üì±</span>
    <div style="flex-grow: 1;"><strong>¬°Instala la App!</strong></div>
    <button id="install-button">Instalar</button>
    <button class="close" id="install-close">√ó</button>
  </div>
  
  <div class="main-wrapper">
    <div class="header-row">
      <div class="header-controls">
        <select id="mes" class="selector-fecha">
            <option>Enero</option><option>Febrero</option><option>Marzo</option>
            <option>Abril</option><option>Mayo</option><option>Junio</option>
            <option>Julio</option><option>Agosto</option><option>Septiembre</option>
            <option>Octubre</option><option>Noviembre</option><option>Diciembre</option>
        </select>
        <select id="anio" class="selector-fecha"></select>
      </div>
      <button class="config-btn" id="config-btn">‚öôÔ∏è</button>
      <div class="config-menu" id="config-menu">
        <h4>Configurar Apariencia</h4>
        <h5>Colores</h5>
        <div class="color-picker"><label>Ingresos:</label><input type="color" id="color-ingresos"></div>
        <div class="color-picker"><label>Restante:</label><input type="color" id="color-restante"></div>
        <div class="color-picker"><label>Gasto Semanal:</label><input type="color" id="color-gasto-semanal"></div>
        <div class="color-picker"><label>Principal:</label><input type="color" id="color-primary"></div>
        <div class="color-picker"><label>Texto:</label><input type="color" id="color-text"></div>
        <h5>Fuentes</h5>
        <div class="range-slider"><label>Gral:</label><input type="range" id="font-size" min="10" max="20" step="1"></div>
        <h5>Datos</h5>
        <button id="descargar-backup" class="btn" style="width:100%; margin-bottom: 10px; background: var(--primary);">Descargar Backup</button>
        <button id="subir-backup" class="btn" style="width:100%; margin-bottom: 10px; background: var(--primary);">Cargar Backup</button>
        <input type="file" id="cargar-backup" accept="application/json" style="display:none;">
        <button id="reset-styles" class="btn no-pagado" style="width:100%; margin-bottom: 10px;">Restaurar Estilos</button>
        <button id="limpiar-datos" class="btn" style="width:100%; background:#ef4444;">Limpiar Todo</button>
      </div>
    </div>
  
    <div class="container">
      <div class="card">
        <div class="gasto-actions">
          <button id="agregar-gasto">+ Gasto</button>
          <button id="copiar-gastos" class="btn">üìã Copiar Mes Ant.</button>
        </div>
        <table id="gastos-table">
          <thead><tr><th>Cat.</th><th>Gasto</th><th>Importe</th><th>Estado</th><th>Eliminar</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      
      <div class="card ingresos-resumen">
        <div class="seccion seccion-ingresos">
          <h3 style="margin-top:0;text-align:center;">Ingresos</h3>
          <div class="inputs-ingresos">
            <div class="input-group"><label>Sueldo:</label><input type="text" id="sueldo" placeholder="0" inputmode="numeric"></div>
            <div class="input-group"><label>SAC:</label><input type="text" id="aguinaldo" placeholder="0" inputmode="numeric"></div>
            <div class="input-group"><label>Extra:</label><input type="text" id="extra" placeholder="0" inputmode="numeric"></div>
          </div>
        </div>
        <div class="separador"></div>
        <div class="seccion seccion-resumen">
          <div class="resumen">
            <div class="valor-display" id="total-restante"><div class="valor-label">Restante</div><div class="valor-importe">0</div></div>
          </div>
        </div>
        <div class="separador"></div>
        <div class="seccion seccion-division">
          <div class="division"><label>Dividir en:</label><select id="dividir"><option value="4">4 Semanas</option><option value="5">5 Semanas</option></select></div>
          <div class="valor-display" id="total-por-parte"><div class="valor-label">Gasto Semanal</div><div class="valor-importe">0</div></div>
        </div>
      </div>

      <div class="card full-width-card">
        <h3 style="text-align:center; margin-top:0;">Estad√≠sticas (Por Categor√≠a)</h3>
        <div class="chart-container"><canvas id="gastosChart"></canvas></div>
        <div id="gastos-comparacion" style="text-align:center; margin-top: 15px; font-size: 1rem;"></div>
      </div>
    </div>
  </div> 
  
  <script>
    // --- SISTEMA DE MODALES ---
    const modalInfo = document.getElementById('info-modal');
    const modalConfirm = document.getElementById('confirm-modal');
    let confirmCallback = null;

    function showInfo(message, title = 'Informaci√≥n') {
        document.getElementById('info-modal-title').innerText = title;
        document.getElementById('info-modal-message').innerText = message;
        modalInfo.classList.add('active');
    }

    document.getElementById('info-modal-ok').onclick = () => {
        modalInfo.classList.remove('active');
    };

    function showConfirm(message, callback, title = 'Confirmar', isDelete = false) {
        document.getElementById('confirm-modal-title').innerText = title;
        document.getElementById('confirm-modal-message').innerText = message;
        
        const btnYes = document.getElementById('confirm-modal-yes');
        if (isDelete) {
            btnYes.className = 'btn-modal btn-modal-delete';
            btnYes.innerText = 'Eliminar';
        } else {
            btnYes.className = 'btn-modal btn-modal-confirm';
            btnYes.innerText = 'Confirmar';
        }

        confirmCallback = callback;
        modalConfirm.classList.add('active');
    }

    document.getElementById('confirm-modal-cancel').onclick = () => {
        modalConfirm.classList.remove('active');
        confirmCallback = null;
    };

    document.getElementById('confirm-modal-yes').onclick = () => {
        modalConfirm.classList.remove('active');
        if (confirmCallback) confirmCallback();
    };

    // --- PWA SETUP ---
    if ('serviceWorker' in navigator && (window.location.protocol.indexOf('http') === 0)) {
      window.addEventListener('load', () => {
        const swCode = `
          const CACHE_NAME = 'gastos-app-v3';
          self.addEventListener('install', e => e.waitUntil(caches.open(CACHE_NAME).then(c => c.addAll(['./']))));
          self.addEventListener('fetch', e => e.respondWith(caches.match(e.request).then(r => r || fetch(e.request))));
        `;
        const blob = new Blob([swCode], { type: 'application/javascript' });
        navigator.serviceWorker.register(URL.createObjectURL(blob))
            .catch(err => console.log('SW registration skipped:', err));
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      // DOM Elements
      const mesSelect = document.getElementById('mes');
      const anioSelect = document.getElementById('anio');
      const agregarBtn = document.getElementById('agregar-gasto');
      const copiarBtn = document.getElementById('copiar-gastos');
      const gastosTable = document.querySelector('#gastos-table tbody');
      const inputsIngresos = [document.getElementById('sueldo'), document.getElementById('aguinaldo'), document.getElementById('extra')];
      const totalRestanteImporte = document.querySelector('#total-restante .valor-importe');
      const dividirSelect = document.getElementById('dividir');
      const totalPorParteImporte = document.querySelector('#total-por-parte .valor-importe');
      const configInputs = {
        '--ingresos-color': document.getElementById('color-ingresos'),
        '--restante-color': document.getElementById('color-restante'),
        '--gasto-semanal-color': document.getElementById('color-gasto-semanal'),
        '--primary': document.getElementById('color-primary'),
        '--text': document.getElementById('color-text'),
        '--base-font-size': document.getElementById('font-size')
      };
      
      const ctx = document.getElementById('gastosChart').getContext('2d');
      let gastosChart = null;
      
      let datos = JSON.parse(localStorage.getItem('gastos-mensuales') || '{}');
      const meses = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
      
      // Estado de grupos colapsados (se persiste en localStorage)
      let gruposColapsados = JSON.parse(localStorage.getItem('grupos-colapsados') || '{}');

      // Categor√≠as disponibles (Sectorizar)
      const categorias = [
        { id: 'varios', icon: 'üì¶', label: 'Varios' },
        { id: 'casa', icon: 'üè†', label: 'Casa' },
        { id: 'comida', icon: 'üçî', label: 'Comida' },
        { id: 'transporte', icon: 'üöó', label: 'Transp.' },
        { id: 'servicios', icon: 'üí°', label: 'Servic.' },
        { id: 'tarjetas', icon: 'üí≥', label: 'Tarjetas' },
        { id: 'salud', icon: 'üíä', label: 'Salud' },
        { id: 'ocio', icon: 'üéâ', label: 'Ocio' },
        { id: 'ahorro', icon: 'üê∑', label: 'Ahorro' }
      ];

      const initYears = () => {
          const currentYear = new Date().getFullYear();
          for(let y = currentYear - 5; y <= currentYear + 5; y++) {
              const opt = document.createElement('option');
              opt.value = y;
              opt.text = y;
              if (y === currentYear) opt.selected = true;
              anioSelect.appendChild(opt);
          }
      };
      initYears();

      const migrarDatos = () => {
          let huboCambios = false;
          const currentYear = new Date().getFullYear();
          const nuevasKeys = {};
          
          Object.keys(datos).forEach(key => {
              // Migraci√≥n de claves antiguas
              if (!key.includes('-')) {
                  const newKey = `${key}-${currentYear}`;
                  if (!datos[newKey]) {
                      nuevasKeys[newKey] = datos[key];
                      huboCambios = true;
                  }
              } else {
                  nuevasKeys[key] = datos[key];
              }
              
              // Migraci√≥n de estructura para categor√≠as y semanas
              if(nuevasKeys[key] || datos[key]) {
                  const data = nuevasKeys[key] || datos[key];
                  if(data.gastos) {
                      data.gastos.forEach(g => {
                          if(!g.categoria) {
                              g.categoria = 'varios';
                              huboCambios = true;
                          }
                      });
                  }
                  if(!data.semanas) {
                      data.semanas = "4"; // Default 4 semanas
                      huboCambios = true;
                  }
              }
          });
          
          if (huboCambios) {
              datos = nuevasKeys;
              localStorage.setItem('gastos-mensuales', JSON.stringify(datos));
          }
      };
      migrarDatos();

      const getPeriodoActual = () => `${mesSelect.value}-${anioSelect.value}`;

      let configuracion = {};
      const defaultConfig = {
        '--ingresos-color': '#f9fafb', '--restante-color': '#22c55e', '--gasto-semanal-color': '#f59e0b',
        '--primary': '#3b82f6', '--text': '#f9fafb', '--base-font-size': '16'
      };

      const formatNumber = (num) => num.toLocaleString('es-AR', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
      const parseFormattedNumber = (text) => parseInt(text.toString().replace(/\./g, '')) || 0;

      window.formatearMonedaInput = (input) => {
        let value = input.value.replace(/\./g, '');
        if (!isNaN(value) && value !== '') input.value = formatNumber(parseInt(value));
        else if (value === '') input.value = '';
        const index = input.getAttribute('data-index');
        if (index !== null) window.actualizarImporteGasto(index, input.value);
      };

      // --- FUNCIONES PRINCIPALES ---
      
      const asegurarMes = () => {
        const periodo = getPeriodoActual();
        if (!datos[periodo]) {
          datos[periodo] = { gastos: [], sueldo: 0, aguinaldo: 0, extra: 0, semanas: "4" };
        }
        localStorage.setItem('gastos-mensuales', JSON.stringify(datos));
      };

      const guardarDatos = () => {
        const periodo = getPeriodoActual();
        if(datos[periodo]){
            datos[periodo].sueldo = parseFormattedNumber(inputsIngresos[0].value) || 0;
            datos[periodo].aguinaldo = parseFormattedNumber(inputsIngresos[1].value) || 0;
            datos[periodo].extra = parseFormattedNumber(inputsIngresos[2].value) || 0;
            // Guardar configuraci√≥n de semanas
            datos[periodo].semanas = dividirSelect.value;
            localStorage.setItem('gastos-mensuales', JSON.stringify(datos));
        }
        actualizarTotales(); // Importante: Recalcular visualmente
        actualizarComparacion();
      };

      function actualizarComparacion() {
        const mesActual = mesSelect.value;
        const anioActual = parseInt(anioSelect.value);
        const idx = meses.indexOf(mesActual);
        
        let mesAnterior, anioAnterior;
        
        if (idx === 0) { 
            mesAnterior = meses[11];
            anioAnterior = anioActual - 1;
        } else {
            mesAnterior = meses[idx - 1];
            anioAnterior = anioActual;
        }

        const periodoActual = `${mesActual}-${anioActual}`;
        const periodoAnterior = `${mesAnterior}-${anioAnterior}`;

        const totalActual = (datos[periodoActual]?.gastos || []).reduce((acc, g) => acc + (Number(g.importe) || 0), 0);
        const totalAnterior = (datos[periodoAnterior]?.gastos || []).reduce((acc, g) => acc + (Number(g.importe) || 0), 0);
        
        const divComparacion = document.getElementById('gastos-comparacion');
        
        if (!datos[periodoAnterior] || (totalAnterior === 0 && datos[periodoAnterior].gastos.length === 0)) {
            divComparacion.innerHTML = '<span style="color: rgba(255,255,255,0.5)">Sin datos previos</span>';
            return;
        }

        const diferencia = totalActual - totalAnterior;
        
        if (diferencia > 0) {
            divComparacion.innerHTML = `
                <span style="color: #ef4444; display: flex; align-items: center; justify-content: center; gap: 5px;">
                    <span style="font-size: 1.2em;">‚¨Ü</span> $${formatNumber(diferencia)} m√°s que en ${mesAnterior}
                </span>`;
        } else if (diferencia < 0) {
            divComparacion.innerHTML = `
                <span style="color: #22c55e; display: flex; align-items: center; justify-content: center; gap: 5px;">
                    <span style="font-size: 1.2em;">‚¨á</span> $${formatNumber(Math.abs(diferencia))} menos que en ${mesAnterior}
                </span>`;
        } else {
            divComparacion.innerHTML = '<span style="color: var(--text)">Igual que el mes anterior</span>';
        }
      }

      function actualizarTotales() {
        const periodo = getPeriodoActual();
        const { sueldo = 0, aguinaldo = 0, extra = 0, gastos = [] } = datos[periodo] || {};
        const ingresos = Number(sueldo) + Number(aguinaldo) + Number(extra);
        const totalGastos = gastos.reduce((a, g) => a + (Number(g.importe) || 0), 0);
        const restante = ingresos - totalGastos;
        
        totalRestanteImporte.textContent = formatNumber(restante);
        
        // Usar valor del selector (que ahora se sincroniza con los datos)
        const partes = parseInt(dividirSelect.value) || 4;
        totalPorParteImporte.textContent = formatNumber(restante / partes);
        
        updateChart(); 
        actualizarComparacion(); // <- L√çNEA CLAVE AGREGADA PARA REACTIVAR ESTAD√çSTICA
      }

      // Funci√≥n para alternar estado de colapso de un grupo
      window.toggleGrupo = (catId) => {
        if(gruposColapsados[catId]) {
            delete gruposColapsados[catId];
        } else {
            gruposColapsados[catId] = true;
        }
        localStorage.setItem('grupos-colapsados', JSON.stringify(gruposColapsados));
        renderGastos();
      };

      function renderGastos() {
        gastosTable.innerHTML = '';
        const periodo = getPeriodoActual();
        if (!datos[periodo] || !Array.isArray(datos[periodo].gastos)) return;
        
        // 1. Agrupar gastos preservando √≠ndice original
        const grupos = {};
        categorias.forEach(c => grupos[c.id] = []); // Inicializar grupos
        if (!grupos['varios']) grupos['varios'] = []; // Asegurar varios

        datos[periodo].gastos.forEach((gasto, index) => {
            const catId = gasto.categoria || 'varios';
            if (!grupos[catId]) grupos[catId] = []; // Por si acaso
            grupos[catId].push({ ...gasto, originalIndex: index });
        });

        // 2. Renderizar por grupos
        let hayGastos = false;
        
        // Usamos la lista de categorias para el orden de visualizaci√≥n
        const categoriasAImprimir = categorias.map(c => c.id);
        // A√±adir las que falten si existen en datos
        Object.keys(grupos).forEach(k => { if(!categoriasAImprimir.includes(k)) categoriasAImprimir.push(k); });

        categoriasAImprimir.forEach(catId => {
            const gastosDelGrupo = grupos[catId];
            if (gastosDelGrupo && gastosDelGrupo.length > 0) {
                hayGastos = true;
                
                // Header del Grupo
                const catInfo = categorias.find(c => c.id === catId) || { icon: 'üìÇ', label: catId };
                const subtotal = gastosDelGrupo.reduce((acc, item) => acc + (Number(item.importe) || 0), 0);
                const isCollapsed = gruposColapsados[catId];
                const arrow = `
<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
  <path d="M6 9l6 6 6-6"/>
</svg>`

                const trHeader = document.createElement('tr');
                trHeader.className = isCollapsed ? 'group-header group-collapsed' : 'group-header';
                trHeader.onclick = () => toggleGrupo(catId);
                
                trHeader.innerHTML = `
                    <td colspan="5">
                        <div style="display:flex; justify-content:space-between; align-items:center; padding: 0 5px;">
                            <span style="display:flex; align-items:center;">
                                <span class="arrow-icon">${arrow}</span> ${catInfo.icon} ${catInfo.label}
                            </span>
                            <span id="group-total-${catId}" style="font-size: 0.9em; opacity: 0.8;">$${formatNumber(subtotal)}</span>
                        </div>
                    </td>
                `;
                gastosTable.appendChild(trHeader);

                // Si no est√° colapsado, mostramos los gastos
                if (!isCollapsed) {
                    gastosDelGrupo.forEach(item => {
                        const index = item.originalIndex; // Usar √≠ndice original para editar/borrar
                        const tr = document.createElement('tr');
                        if (item.pagado) tr.classList.add("pagado-row");

                        let catOptions = '';
                        categorias.forEach(cat => {
                            const selected = (item.categoria || 'varios') === cat.id ? 'selected' : '';
                            catOptions += `<option value="${cat.id}" ${selected}>${cat.icon}</option>`;
                        });

                        tr.innerHTML = `
                            <td>
                                <select class="cat-select" onchange="actualizarCategoria(${index}, this.value)">
                                    ${catOptions}
                                </select>
                            </td>
                            <td><input type="text" value="${item.nombre}" style="background:transparent;border:none;color:inherit;width:100%;text-align:center;font-weight:bold;" onchange="actualizarNombreGasto(${index}, this.value)" onfocus="this.select()"></td>
                            <td><input type="text" value="${formatNumber(item.importe)}" style="background:transparent;border:none;color:inherit;width:100%;text-align:center;font-weight:bold;" data-index="${index}" oninput="formatearMonedaInput(this)" inputmode="numeric" onfocus="this.select()"></td>
                            
                            <td>
                            <label class="checkbox">
                                <input type="checkbox" ${item.pagado ? 'checked' : ''} onchange="togglePagado(${index})" />
                                <svg viewBox="0 0 44 44" class="sizer checkmark">
                                    <path d="M14,24 L21,31 L39.7428882,11.5937758 C35.2809627,6.53125861 30.0333333,4 24,4 C12.95,4 4,12.95 4,24 C4,35.05 12.95,44 24,44 C35.05,44 44,35.05 44,24 C44,19.3 42.5809627,15.1645919 39.7428882,11.5937758" transform="translate(-2.000000, -2.000000)"></path>
                                </svg>
                            </label>
                            </td>

                            <td><button class="delete-btn" onclick="eliminarGasto(${index})">‚ùå</button></td>
                        `;
                        gastosTable.appendChild(tr);
                    });
                }
            }
        });
        
        if (!hayGastos) {
            gastosTable.innerHTML = '<tr><td colspan="5" style="padding:20px; opacity:0.5;">No hay gastos cargados</td></tr>';
        }

        actualizarTotales();
      }

      function renderInputs() {
        const periodo = getPeriodoActual();
        if (!datos[periodo]) return;
        inputsIngresos[0].value = formatNumber(datos[periodo].sueldo || 0);
        inputsIngresos[1].value = formatNumber(datos[periodo].aguinaldo || 0);
        inputsIngresos[2].value = formatNumber(datos[periodo].extra || 0);
        
        // Cargar preferencia de semanas guardada
        if(datos[periodo].semanas) {
            dividirSelect.value = datos[periodo].semanas;
        } else {
            dividirSelect.value = "4";
        }
      }

      function updateChart() {
        const periodo = getPeriodoActual();
        if (!datos[periodo]) return;
        const gastos = datos[periodo].gastos || [];
        
        // Agrupar por categor√≠a
        const gastosPorCategoria = {};
        gastos.forEach(g => {
            const cat = g.categoria || 'varios';
            const importe = Number(g.importe) || 0;
            if(importe > 0) {
                if(!gastosPorCategoria[cat]) gastosPorCategoria[cat] = 0;
                gastosPorCategoria[cat] += importe;
            }
        });

        // Preparar datos para el gr√°fico
        // Ordenar de mayor a menor gasto
        const entries = Object.entries(gastosPorCategoria).sort((a,b) => b[1] - a[1]);
        
        const labels = entries.map(([key, val]) => {
            const catInfo = categorias.find(c => c.id === key) || { icon: 'üì¶', label: 'Varios' };
            return `${catInfo.icon} ${catInfo.label}`;
        });
        const dataValues = entries.map(([_, val]) => val);
        
        const backgroundColors = entries.map((_, i) => `hsla(${(i * 137.5) % 360}, 70%, 60%, 0.7)`);
        const borderColors = entries.map((_, i) => `hsla(${(i * 137.5) % 360}, 70%, 40%, 1)`);

        if (gastosChart) {
            gastosChart.data.labels = labels;
            gastosChart.data.datasets[0].data = dataValues;
            gastosChart.data.datasets[0].backgroundColor = backgroundColors;
            gastosChart.data.datasets[0].borderColor = borderColors;
            gastosChart.update();
        } else {
            gastosChart = new Chart(ctx, {
                type: 'doughnut', 
                data: { labels, datasets: [{ data: dataValues, backgroundColor: backgroundColors, borderColor: borderColors, borderWidth: 1 }] },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    plugins: { 
                        legend: { position: 'right', labels: { color: '#f9fafb', boxWidth: 10, font: { size: 10 } } },
                        tooltip: {
                             callbacks: {
                                 label: function(context) {
                                     let label = context.label || '';
                                     if (label) {
                                         label += ': ';
                                     }
                                     if (context.parsed !== null) {
                                         label += '$' + formatNumber(context.parsed);
                                     }
                                     return label;
                                 }
                             }
                        }
                    } 
                }
            });
        }
      }

      window.actualizarNombreGasto = (index, val) => {
        const p = getPeriodoActual();
        datos[p].gastos[index].nombre = val;
        guardarDatos();
      };

      window.actualizarCategoria = (index, val) => {
        const p = getPeriodoActual();
        datos[p].gastos[index].categoria = val;
        guardarDatos(); // Esto actualizar√° el gr√°fico autom√°ticamente
        renderGastos(); // Re-renderizar para mover la fila al grupo correcto
      };
      
      window.actualizarImporteGasto = (index, val) => {
        const p = getPeriodoActual();
        const gasto = datos[p].gastos[index];
        gasto.importe = parseFormattedNumber(val);
        localStorage.setItem('gastos-mensuales', JSON.stringify(datos));
        actualizarTotales();

        // Actualizar subtotal del grupo espec√≠ficamente sin redibujar toda la tabla
        const catId = gasto.categoria || 'varios';
        const totalGroup = datos[p].gastos
            .filter(g => (g.categoria || 'varios') === catId)
            .reduce((sum, g) => sum + (Number(g.importe) || 0), 0);
            
        const headerTotal = document.getElementById(`group-total-${catId}`);
        if (headerTotal) {
            headerTotal.innerText = '$' + formatNumber(totalGroup);
        }
      };

      window.togglePagado = (index) => {
        const p = getPeriodoActual();
        datos[p].gastos[index].pagado = !datos[p].gastos[index].pagado;
        guardarDatos();
        renderGastos(); // Necesario para actualizar estilo de la fila
      };

      window.eliminarGasto = (index) => {
        showConfirm(
            '¬øEst√°s de acuerdo en eliminar este gasto?',
            () => {
                const p = getPeriodoActual();
                datos[p].gastos.splice(index, 1);
                guardarDatos();
                renderGastos();
            },
            'Eliminar Gasto',
            true 
        );
      };

      // --- EVENT LISTENERS ---
      
      const handleDateChange = () => {
          asegurarMes();
          renderInputs();
          renderGastos();
          actualizarComparacion(); // Actualizar comparaci√≥n al cambiar mes
      };
      mesSelect.addEventListener('change', handleDateChange);
      anioSelect.addEventListener('change', handleDateChange);

      agregarBtn.addEventListener('click', () => {
        asegurarMes();
        const p = getPeriodoActual();
        // Categoria default: varios
        datos[p].gastos.push({ nombre: 'Nuevo', importe: 0, pagado: false, categoria: 'varios' });
        // Si la categor√≠a 'varios' estaba colapsada, la abrimos para ver el nuevo gasto
        if(gruposColapsados['varios']) {
            delete gruposColapsados['varios'];
            localStorage.setItem('grupos-colapsados', JSON.stringify(gruposColapsados));
        }
        guardarDatos();
        renderGastos();
      });
      
      copiarBtn.addEventListener('click', () => {
        const mesActual = mesSelect.value;
        const anioActual = parseInt(anioSelect.value);
        const idx = meses.indexOf(mesActual);
        
        let mesAnterior, anioAnterior;
        if (idx === 0) { mesAnterior = meses[11]; anioAnterior = anioActual - 1; }
        else { mesAnterior = meses[idx - 1]; anioAnterior = anioActual; }
        
        const keyAnterior = `${mesAnterior}-${anioAnterior}`;
        
        if (!datos[keyAnterior] || !datos[keyAnterior].gastos?.length) {
            showInfo(`No hay datos en ${mesAnterior} ${anioAnterior} para copiar.`);
            return;
        }

        showConfirm(`¬øCopiar gastos de ${mesAnterior} ${anioAnterior}?`, () => {
            const p = getPeriodoActual();
            const actuales = new Set(datos[p].gastos.map(g => g.nombre));
            const nuevos = datos[keyAnterior].gastos
                .filter(g => g.importe > 0 && !actuales.has(g.nombre))
                .map(g => ({ ...g, pagado: false })); // Mantiene la categor√≠a
            
            if(nuevos.length === 0) {
                showInfo("Todos los gastos ya existen en este mes.");
                return;
            }
            datos[p].gastos.push(...nuevos);
            guardarDatos();
            renderGastos();
        }, "Copiar Gastos");
      });

      document.getElementById('config-btn').onclick = (e) => { e.stopPropagation(); document.getElementById('config-menu').classList.toggle('active'); };
      document.addEventListener('click', (e) => { 
        if (!e.target.closest('#config-menu') && !e.target.closest('#config-btn')) document.getElementById('config-menu').classList.remove('active'); 
      });

      document.getElementById('descargar-backup').onclick = () => {
        const a = document.createElement('a');
        a.href = 'data:application/json;charset=utf-8,'+ encodeURIComponent(JSON.stringify(datos));
        a.download = `gastos-backup-${new Date().toISOString().slice(0,10)}.json`;
        a.click();
      };
      
      document.getElementById('subir-backup').onclick = () => document.getElementById('cargar-backup').click();
      document.getElementById('cargar-backup').onchange = (e) => {
         const r = new FileReader();
         r.onload = (ev) => {
             try {
                 datos = JSON.parse(ev.target.result);
                 migrarDatos();
                 localStorage.setItem('gastos-mensuales', JSON.stringify(datos));
                 asegurarMes();
                 renderInputs();
                 renderGastos();
                 showInfo('Backup cargado correctamente');
             } catch(err) { showInfo('Error al leer el archivo'); }
         };
         if(e.target.files[0]) r.readAsText(e.target.files[0]);
         e.target.value = '';
      };

      document.getElementById('limpiar-datos').onclick = () => {
          showConfirm('¬øEliminar TODOS los datos de la app? No se pueden recuperar.', () => {
              datos = {};
              localStorage.setItem('gastos-mensuales', JSON.stringify({}));
              asegurarMes();
              renderInputs();
              renderGastos();
          }, 'Atenci√≥n', true);
      };

      const applyConfig = () => {
        Object.entries(configuracion).forEach(([k, v]) => {
           const suffix = k.includes('font-size') ? 'px' : '';
           document.documentElement.style.setProperty(k, v + suffix);
        });
      };
      const loadConfig = () => {
          configuracion = { ...defaultConfig, ...JSON.parse(localStorage.getItem('app-config') || '{}') };
          applyConfig();
          Object.entries(configInputs).forEach(([k, el]) => { if(el) el.value = configuracion[k]; });
      };
      Object.entries(configInputs).forEach(([k, el]) => {
         if(el) el.oninput = () => { configuracion[k] = el.value; applyConfig(); localStorage.setItem('app-config', JSON.stringify(configuracion)); };
      });
      document.getElementById('reset-styles').onclick = () => {
          localStorage.removeItem('app-config');
          loadConfig();
      };

      // Listener para Inputs de Ingresos: Ahora llama a guardarDatos, que a su vez llama a actualizarTotales
      inputsIngresos.forEach(i => i.addEventListener('input', () => { window.formatearMonedaInput(i); guardarDatos(); }));
      
      // Listener para el cambio de semanas: Guarda y recalcula
      dividirSelect.addEventListener('change', () => {
          guardarDatos();
      });

      mesSelect.selectedIndex = new Date().getMonth();
      loadConfig();
      asegurarMes();
      renderInputs();
      renderGastos();
    });
  </script>
</body>
</html>

